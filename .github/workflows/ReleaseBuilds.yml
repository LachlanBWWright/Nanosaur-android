name: Make Release Builds

on:
  push:
    branches: [main, master]
  workflow_dispatch:

jobs:
  build-linux-appimage:
    runs-on: ${{ matrix.platform.os }}
    timeout-minutes: 5
    strategy:
      fail-fast: false
      matrix:
        platform:  # Use oldest available Ubuntu for maximum glibc compatibility
          - { name: x86_64, os: ubuntu-22.04 }
          - { name: aarch64, os: ubuntu-22.04-arm }
    steps:
      - uses: actions/checkout@v4
        with: {submodules: 'recursive'}
      - name: Get build dependencies from APT
        # cf. https://github.com/libsdl-org/SDL/blob/main/docs/README-linux.md
        # + desktop-file-utils for appimagetool
        run: |
          sudo apt update
          sudo apt install -y libasound2-dev libpulse-dev \
            libaudio-dev libjack-dev libsndio-dev libx11-dev libxext-dev \
            libxrandr-dev libxcursor-dev libxfixes-dev libxi-dev libxss-dev \
            libxkbcommon-dev libdrm-dev libgbm-dev libgl1-mesa-dev libgles2-mesa-dev \
            libegl1-mesa-dev libdbus-1-dev libibus-1.0-dev libudev-dev fcitx-libs-dev \
            libpipewire-0.3-dev libwayland-dev libdecor-0-dev liburing-dev \
            desktop-file-utils
      - run: echo "ARTIFACT_NAME=$(python3 build.py --print-artifact-name)" >> $GITHUB_ENV
      - run: python3 build.py --dependencies
      - run: python3 build.py --configure
      - run: python3 build.py --build
      - run: python3 build.py --package
      - uses: actions/upload-artifact@v4
        with:
          name: ${{env.ARTIFACT_NAME}}
          path: dist/
          compression-level: 0

  build-windows:
    runs-on: windows-2022
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v4
        with: {submodules: 'recursive'}
      - run: |
          $ARTIFACT_NAME = python3 build.py --print-artifact-name
          echo "ARTIFACT_NAME=$ARTIFACT_NAME" >> $env:GITHUB_ENV
      - run: python3 build.py --dependencies
      - run: python3 build.py --configure -G 'Visual Studio 17 2022'
      - run: python3 build.py --build
      - run: python3 build.py --package
      - uses: actions/upload-artifact@v4
        with:
          name: ${{env.ARTIFACT_NAME}}
          path: dist/
          compression-level: 0

  build-macos:
    runs-on: macos-latest  # as of January 2025, this still supports the macOS 10.13 deployment target
    timeout-minutes: 15
    env:
      CODE_SIGN_IDENTITY: ${{ secrets.APPLE_CODE_SIGN_IDENTITY }}
    steps:
      - uses: apple-actions/import-codesign-certs@v3
        with:
          p12-file-base64: ${{ secrets.APPLE_DEVELOPER_CERTIFICATE_P12_BASE64 }}
          p12-password: ${{ secrets.APPLE_DEVELOPER_CERTIFICATE_PASSWORD }}
      - uses: actions/checkout@v4
        with: {submodules: 'recursive'}
      - name: Get artifact name
        run: echo "ARTIFACT_NAME=$(python3 build.py --print-artifact-name)" >> $GITHUB_ENV
      - run: python3 build.py --dependencies
      - run: python3 build.py --configure
      - run: python3 build.py --build
      - run: python3 build.py --package
      - name: Notarize
        run: |
          xcrun notarytool store-credentials GameNotarizationProfile --apple-id ${{ secrets.APPLE_NOTARIZATION_USERNAME }} --password ${{ secrets.APPLE_NOTARIZATION_PASSWORD }} --team-id ${{ secrets.APPLE_DEVELOPMENT_TEAM }}
          xcrun notarytool submit "dist/$ARTIFACT_NAME" --keychain-profile GameNotarizationProfile --wait
      - name: Staple
        run: xcrun stapler staple "dist/$ARTIFACT_NAME"
      - uses: actions/upload-artifact@v4
        with:
          name: ${{env.ARTIFACT_NAME}}
          path: dist/
          compression-level: 0

  build-wasm:
    runs-on: ubuntu-22.04
    timeout-minutes: 45
    permissions:
      contents: write
      pages: write
      id-token: write
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: 'recursive'

      - name: Install Emscripten (with cache)
        uses: mymindstorm/setup-emsdk@v14
        with:
          version: latest
          actions-cache-folder: 'emsdk-cache'

      - name: Cache SDL3 Emscripten build
        id: cache-sdl3-em
        uses: actions/cache@v4
        with:
          path: /tmp/sdl3-em-install
          key: sdl3-em-3.2.8-${{ runner.os }}

      - name: Build SDL3 for Emscripten
        if: steps.cache-sdl3-em.outputs.cache-hit != 'true'
        run: |
          SDL_VER=3.2.8
          wget -q https://libsdl.org/release/SDL3-${SDL_VER}.tar.gz -O /tmp/SDL3.tar.gz
          tar -xzf /tmp/SDL3.tar.gz -C /tmp
          cd /tmp/SDL3-${SDL_VER}
          mkdir build && cd build
          emcmake cmake -S .. -B . \
            -DCMAKE_BUILD_TYPE=Release \
            -DSDL_SHARED=OFF \
            -DSDL_STATIC=ON \
            -DSDL_TESTS=OFF \
            -DSDL_EXAMPLES=OFF
          emmake make -j$(nproc)
          cmake --install . --prefix /tmp/sdl3-em-install

      - name: Configure (Emscripten)
        run: |
          emcmake cmake -S . -B build-wasm \
            -DCMAKE_BUILD_TYPE=Release \
            -DBUILD_SDL_FROM_SOURCE=OFF \
            -DSDL_STATIC=ON \
            -DSDL3_DIR=/tmp/sdl3-em-install/lib/cmake/SDL3

      - name: Build
        run: |
          emmake cmake --build build-wasm -j$(nproc)

      - name: Package WebAssembly bundle
        run: |
          mkdir -p dist/wasm/game
          # Nanosaur.html is the shell with embedded Emscripten bootstrap script
          cp build-wasm/Nanosaur.html  dist/wasm/game/index.html
          cp build-wasm/Nanosaur.js    dist/wasm/game/
          cp build-wasm/Nanosaur.wasm  dist/wasm/game/
          cp build-wasm/Nanosaur.data  dist/wasm/game/
          # Copy GitHub Pages landing page
          cp docs/index.html           dist/wasm/index.html
          cd dist
          zip -r Nanosaur-wasm.zip wasm/

      - name: Upload WebAssembly artifact
        uses: actions/upload-artifact@v4
        with:
          name: Nanosaur-wasm
          path: dist/wasm/
          compression-level: 0

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        if: github.event_name == 'push'
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: dist/wasm
          publish_branch: gh-pages
          force_orphan: true
          commit_message: "Deploy WebAssembly build from ${{ github.sha }}"
  create-github-release:
    needs: [build-linux-appimage, build-windows, build-wasm]
    runs-on: ubuntu-22.04
    timeout-minutes: 10
    if: github.event_name == 'push'
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-artifacts/

      - name: Get version
        run: |
          VERSION=$(python3 -c "
          import re
          with open('src/Headers/version.h') as f:
            for line in f:
              m = re.match(r'#define GAME_VERSION\s+\"(.+)\"', line.strip())
              if m:
                print(m.group(1))
                break
          ")
          echo "GAME_VERSION=${VERSION}" >> $GITHUB_ENV

      - name: Prepare WebAssembly zip for release
        run: |
          cd release-artifacts/Nanosaur-wasm
          zip -r ../../Nanosaur-${{ env.GAME_VERSION }}-wasm.zip .

      - name: Create or update GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ env.GAME_VERSION }}-dev
          name: "Nanosaur ${{ env.GAME_VERSION }} (Development Build)"
          body: |
            Automated development build from commit ${{ github.sha }}.

            ### Downloads
            - **WebAssembly**: `Nanosaur-*-wasm.zip` â€“ Run in browser (extract and serve)
            - **Windows**: `Nanosaur-*-windows-x64.zip`
            - **Linux x86_64**: `Nanosaur-*-linux-x86_64.AppImage`
            - **Linux aarch64**: `Nanosaur-*-linux-aarch64.AppImage`

            ### WebAssembly / Level Editor
            The WebAssembly build supports direct level loading:
            ```
            index.html?level=0&skipMenu=1
            ```
            See the [GitHub Pages site](https://LachlanBWWright.github.io/Nanosaur-android/) for the hosted version.
          files: |
            release-artifacts/**/*.zip
            release-artifacts/**/*.AppImage
            Nanosaur-${{ env.GAME_VERSION }}-wasm.zip
          prerelease: true
          make_latest: false
