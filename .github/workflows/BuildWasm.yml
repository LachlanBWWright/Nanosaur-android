name: Build WebAssembly

on:
  push:
    branches: [main, master]
  workflow_dispatch:

jobs:
  build-wasm:
    runs-on: ubuntu-22.04
    timeout-minutes: 30

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: 'recursive'

      - name: Install Emscripten
        run: |
          git clone https://github.com/emscripten-core/emsdk.git /tmp/emsdk
          /tmp/emsdk/emsdk install latest
          /tmp/emsdk/emsdk activate latest

      - name: Build SDL3 for Emscripten
        run: |
          source /tmp/emsdk/emsdk_env.sh
          SDL_VER=3.2.8
          wget -q https://libsdl.org/release/SDL3-${SDL_VER}.tar.gz -O /tmp/SDL3.tar.gz
          tar -xzf /tmp/SDL3.tar.gz -C /tmp
          cd /tmp/SDL3-${SDL_VER}
          mkdir build && cd build
          emcmake cmake -S .. -B . \
            -DCMAKE_BUILD_TYPE=Release \
            -DSDL_SHARED=OFF \
            -DSDL_STATIC=ON \
            -DSDL_TESTS=OFF \
            -DSDL_EXAMPLES=OFF
          emmake make -j$(nproc)
          emmake make install DESTDIR=/tmp/sdl3-em-install
          echo "SDL3_DIR=/tmp/sdl3-em-install/usr/local/lib/cmake/SDL3" >> $GITHUB_ENV

      - name: Configure (Emscripten)
        run: |
          source /tmp/emsdk/emsdk_env.sh
          emcmake cmake -S . -B build-wasm \
            -DCMAKE_BUILD_TYPE=Release \
            -DBUILD_SDL_FROM_SOURCE=OFF \
            -DSDL_STATIC=ON \
            -DSDL3_DIR="${SDL3_DIR}"

      - name: Build
        run: |
          source /tmp/emsdk/emsdk_env.sh
          emmake cmake --build build-wasm -j$(nproc)

      - name: Package WebAssembly bundle
        run: |
          mkdir -p dist/wasm/game
          cp build-wasm/Nanosaur.js    dist/wasm/game/
          cp build-wasm/Nanosaur.wasm  dist/wasm/game/
          cp build-wasm/Nanosaur.data  dist/wasm/game/
          # Rename shell output to index.html for GitHub Pages
          cp build-wasm/Nanosaur.html  dist/wasm/game/index.html
          # Copy GitHub Pages landing page
          cp docs/index.html           dist/wasm/index.html
          echo "Nanosaur WebAssembly bundle ready"
          ls -lh dist/wasm/game/

      - name: Upload WebAssembly artifact
        uses: actions/upload-artifact@v4
        with:
          name: Nanosaur-wasm
          path: dist/wasm/
          compression-level: 0

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        if: github.event_name == 'push'
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: dist/wasm
          publish_branch: gh-pages
          force_orphan: true
          commit_message: "Deploy WebAssembly build from ${{ github.sha }}"
