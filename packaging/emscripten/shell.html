<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Nanosaur â€” WebAssembly</title>
  <style>
    :root {
      --accent: #ff8800;
      --bg:     #0d0d0d;
      --panel:  #1a1a1a;
      --border: #333;
      --text:   #eee;
      --dim:    #888;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: system-ui, -apple-system, sans-serif;
      line-height: 1.5;
    }

    /* â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #header {
      text-align: center;
      padding: 1.25rem 1rem 0.75rem;
      border-bottom: 1px solid var(--border);
      background: linear-gradient(135deg, #1a0a00, #2a1500);
    }
    #header h1 {
      font-size: 2rem;
      color: var(--accent);
      letter-spacing: 3px;
      text-transform: uppercase;
      text-shadow: 0 2px 8px rgba(255,136,0,0.4);
    }
    #header p { color: var(--dim); font-size: 0.85rem; margin-top: 0.25rem; }

    /* â”€â”€ Game area â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #game-wrap {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 1rem;
      position: relative;
    }

    /* Loading card â€” overlays the canvas until game starts */
    #loading-card {
      position: absolute;
      top: 1rem;
      left: 50%;
      transform: translateX(-50%);
      z-index: 10;
      width: 100%;
      max-width: 960px;
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 2rem 1.5rem;
      text-align: center;
    }
    #loading-card h2 {
      color: var(--accent);
      font-size: 1.5rem;
      margin-bottom: 1rem;
    }
    #status-text {
      font-size: 1.05rem;
      color: var(--accent);
      min-height: 1.6rem;
    }
    #progress-bar {
      width: 100%;
      max-width: 420px;
      height: 6px;
      margin: 0.75rem auto 0.35rem;
      accent-color: var(--accent);
    }
    #progress-label { font-size: 0.78rem; color: var(--dim); }

    /* Canvas â€” always in the DOM with proper dimensions for SDL3 */
    #canvas {
      max-width: 100%;
      width: 960px;
      aspect-ratio: 4/3;
      border-radius: 6px;
      outline: none;
      background: #000;
      cursor: crosshair;
    }

    /* Toolbar below canvas */
    #toolbar {
      display: none;
      gap: 0.5rem;
      padding: 0.5rem 0;
      flex-wrap: wrap;
      justify-content: center;
    }

    /* â”€â”€ Generic button â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .btn {
      background: var(--panel);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 0.35rem 0.8rem;
      border-radius: 5px;
      cursor: pointer;
      font-size: 0.88rem;
      transition: background 0.12s, border-color 0.12s;
    }
    .btn:hover  { background: #2a2a2a; border-color: var(--accent); }
    .btn.on     { background: #2a1500; border-color: var(--accent); color: var(--accent); }
    .btn.danger { border-color: #c04040; color: #e06060; }
    .btn.danger:hover { background: #2a0d0d; }

    /* â”€â”€ Controls / API panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #api-panel {
      width: 100%;
      max-width: 960px;
      margin: 0.5rem auto 1.5rem;
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 1.25rem 1.5rem;
    }
    #api-panel h2 {
      color: var(--accent);
      font-size: 1rem;
      margin-bottom: 0.5rem;
    }
    #api-panel .sub {
      color: var(--dim);
      font-size: 0.82rem;
      margin-bottom: 1rem;
    }

    .api-section { margin-bottom: 1.1rem; }
    .api-section h3 {
      font-size: 0.88rem;
      color: #aaa;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      border-bottom: 1px solid var(--border);
      padding-bottom: 0.3rem;
      margin-bottom: 0.6rem;
    }
    .api-row {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin: 0.45rem 0;
      flex-wrap: wrap;
    }
    .api-row label {
      min-width: 160px;
      font-size: 0.88rem;
      color: #b0b0c8;
    }

    .api-section code {
      background: #111;
      color: #7df;
      padding: 2px 6px;
      border-radius: 3px;
      font-size: 0.82rem;
    }

    #score-display { font-size: 0.85em; color: var(--dim); margin-top: 8px; }

    /* â”€â”€ Footer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    footer {
      text-align: center;
      color: #555;
      font-size: 0.75em;
      padding: 1rem;
      border-top: 1px solid #222;
    }
    footer a { color: #777; }
  </style>
</head>
<body>

<div id="header">
  <h1>ğŸ¦• Nanosaur</h1>
  <p>Classic 1998 dinosaur game â€” WebAssembly Edition</p>
</div>

<div id="game-wrap">
  <!-- Loading card overlays the canvas until game starts -->
  <div id="loading-card">
    <h2>ğŸ¦• Nanosaur</h2>
    <div id="status-text">Downloadingâ€¦</div>
    <progress id="progress-bar" value="0" max="1"></progress>
    <div id="progress-label"></div>
  </div>

  <canvas id="canvas" oncontextmenu="event.preventDefault()" tabindex="-1"
          width="960" height="720"></canvas>

  <div id="toolbar">
    <button class="btn" onclick="toggleFullscreen()">â›¶ Fullscreen</button>
    <button class="btn" id="btn-mute" onclick="toggleMute()">ğŸ”Š Unmute</button>
  </div>
</div>

<!-- Controls / Cheat Menu panel -->
<div id="api-panel">
  <h2>ğŸ® Cheat Menu / Level Editor Controls</h2>
  <p class="sub">These controls call exported WASM functions. The game also accepts
    <code>?level=N</code> and <code>?skipMenu=1</code> URL params.</p>

  <div class="api-section">
    <h3>Cheats &amp; Debug</h3>
    <div class="api-row">
      <label>Fence collisions</label>
      <button class="btn on" id="btn-fence" onclick="toggleFence()">âœ“ Enabled</button>
    </div>
    <div class="api-row">
      <button class="btn" onclick="doCheat('CheatRestoreHealth')">â¤ï¸ Restore Health</button>
      <button class="btn" onclick="doCheat('CheatFillFuel')">â›½ Fill Fuel</button>
      <button class="btn" onclick="doCheat('CheatGetWeapons')">ğŸ”« Get All Weapons</button>
      <button class="btn" onclick="doCheat('CheatGetAllEggs')">ğŸ¥š Get All Eggs</button>
    </div>
  </div>

  <div class="api-section">
    <h3>Terrain Override</h3>
    <div class="api-row">
      <label>Upload .ter file</label>
      <input type="file" id="terrain-file-input" accept=".ter" style="display:none"
             onchange="loadTerrainFile(this)">
      <button class="btn" onclick="document.getElementById('terrain-file-input').click()">
        ğŸ“‚ Upload .ter file
      </button>
      <button class="btn" onclick="clearCustomTerrain()" title="Revert to default terrain">â†©ï¸ Default</button>
      <span id="terrain-file-name" style="font-size:0.75em; color:var(--dim); margin-left:6px;"></span>
    </div>
    <p class="sub">Upload a <code>.ter</code> file to inject custom terrain into the WASM virtual filesystem.
       You can also use <code>FS.writeFile()</code> from the console and then call
       <code>SetCustomTerrainFile</code>.</p>
  </div>

  <div class="api-section">
    <h3>Quick Reference</h3>
    <div class="api-row"><code>SetFenceCollisionsEnabled(0)</code> â€” disable fence collisions</div>
    <div class="api-row"><code>SetFenceCollisionsEnabled(1)</code> â€” re-enable fence collisions</div>
    <div class="api-row"><code>CheatRestoreHealth()</code> â€” restore health</div>
    <div class="api-row"><code>CheatFillFuel()</code> â€” fill jet fuel</div>
    <div class="api-row"><code>CheatGetWeapons()</code> â€” get all weapons</div>
    <div class="api-row"><code>CheatGetAllEggs()</code> â€” get all eggs</div>
    <div class="api-row"><code>GetGameScore()</code> â€” returns current score</div>
    <div class="api-row"><code>SetCustomTerrainFile("/Data/Terrain/foo.ter")</code> â€” override terrain file</div>
    <div class="api-row"><code>ClearCustomTerrainFile()</code> â€” revert to default terrain</div>
  </div>

  <div id="score-display">Score: â€”</div>
</div>

<footer>
  <p>Nanosaur Â© 1998 Pangea Software, Inc. Â· Source port Â© 2025 Iliyas Jorio Â·
     <a href="https://github.com/LachlanBWWright/Nanosaur-android">GitHub</a>
  </p>
</footer>

<script>
  // â”€â”€ URL parameter parsing â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  (function() {
    var params = new URLSearchParams(window.location.search);
    window._startLevel = params.has('level') ? parseInt(params.get('level'), 10) : -1;
    window._skipMenu = params.has('skipMenu') ? parseInt(params.get('skipMenu'), 10) : 0;
    window._startTerrain = params.get('terrainFile') || '';
  })();

  // â”€â”€ Emscripten Module configuration â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  var _fenceEnabled = true;
  var _muted = false;
  var _scoreTimer = null;

  // Global error handlers
  window.addEventListener('error', function(e) {
    console.error('[Nanosaur] Unhandled error:', e.message, e.filename, e.lineno);
  });
  window.addEventListener('unhandledrejection', function(e) {
    console.error('[Nanosaur] Unhandled promise rejection:', e.reason);
  });

  var Module = {
    canvas: document.getElementById('canvas'),

    webglContextAttributes: {
      powerPreference: 'high-performance',
      antialias: false,
      preserveDrawingBuffer: false
    },

    print:    function(t) { console.log('[Nanosaur]', t); },
    printErr: function(t) { console.warn('[Nanosaur stderr]', t); },

    onAbort: function(reason) {
      console.error('[Nanosaur] ABORT:', reason);
      var stext = document.getElementById('status-text');
      if (stext) stext.textContent = 'Error: ' + reason;
      var card = document.getElementById('loading-card');
      if (card) card.style.display = '';
    },

    onExit: function(code) {
      if (code !== 0) {
        console.error('[Nanosaur] Exited with code:', code);
        var stext = document.getElementById('status-text');
        if (stext) stext.textContent = 'Game exited with error (code ' + code + ')';
        var card = document.getElementById('loading-card');
        if (card) card.style.display = '';
      }
    },

    preRun: [function() {
      // Create config directory for persistent settings
      try { FS.mkdir('/home'); } catch(e) {}
      try { FS.mkdir('/home/web_user'); } catch(e) {}
      try { FS.mkdir('/home/web_user/.config'); } catch(e) {}
    }],

    setStatus: function(text) {
      var card  = document.getElementById('loading-card');
      var bar   = document.getElementById('progress-bar');
      var label = document.getElementById('progress-label');
      var stext = document.getElementById('status-text');

      if (!text || text === '') {
        // Loading finished â€” hide overlay, show toolbar
        if (card)  card.style.display = 'none';
        var tb = document.getElementById('toolbar');
        if (tb) tb.style.display = 'flex';
        startScorePolling();
        return;
      }

      if (card) card.style.display = '';

      var m = text.match(/([^(]+)\((\d+(\.\d+)?)\/(\d+)\)/);
      if (m) {
        stext.textContent = m[1].trim();
        var pct = parseInt(m[2]) / parseInt(m[4]);
        bar.value = pct;
        label.textContent = Math.round(pct * 100) + '%';
      } else {
        stext.textContent = text;
      }
    },

    monitorRunDependencies: function(left) {
      var bar = document.getElementById('progress-bar');
      if (left === 0) {
        Module.setStatus('');
      } else {
        if (bar) {
          bar.value = Math.max(0, 1 - (left * 0.02));
        }
      }
    },

    onRuntimeInitialized: function() {
      console.log('[Nanosaur] Runtime initialized');
      var stext = document.getElementById('status-text');
      if (stext) stext.textContent = 'Starting gameâ€¦';
      Module.setStatus('');
    }
  };

  window.onerror = function(msg, url, line) {
    console.error('[Nanosaur] Window error:', msg, url, line);
    var stext = document.getElementById('status-text');
    if (stext) stext.textContent = 'Error: ' + msg;
  };

  // â”€â”€ UI helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  function toggleFence() {
    _fenceEnabled = !_fenceEnabled;
    var btn = document.getElementById('btn-fence');
    try {
      Module.ccall('SetFenceCollisionsEnabled', null, ['number'],
                   [_fenceEnabled ? 1 : 0]);
    } catch (e) {
      console.warn('Module not ready yet:', e);
    }
    if (btn) {
      btn.textContent = _fenceEnabled ? 'âœ“ Enabled' : 'âœ— Disabled';
      btn.className   = 'btn' + (_fenceEnabled ? ' on' : ' danger');
    }
  }

  function doCheat(fnName) {
    try {
      Module.ccall(fnName, null, [], []);
    } catch (e) {
      console.warn('Module not ready yet:', e);
    }
  }

  function startScorePolling() {
    if (_scoreTimer) return;
    _scoreTimer = setInterval(function() {
      try {
        var score = Module.ccall('GetGameScore', 'number', [], []);
        document.getElementById('score-display').textContent = 'Score: ' + score;
      } catch (e) { /* not ready */ }
    }, 500);
  }

  function toggleFullscreen() {
    var c = document.getElementById('canvas');
    if (!c) return;
    if (document.fullscreenElement) {
      document.exitFullscreen();
    } else {
      c.requestFullscreen().catch(function (e) { console.warn(e); });
    }
  }

  function toggleMute() {
    _muted = !_muted;
    var btn = document.getElementById('btn-mute');
    try {
      var ctx = Module.SDL2 && Module.SDL2.audioContext;
      if (ctx) {
        if (_muted) ctx.suspend(); else ctx.resume();
      }
    } catch (e) { /* ignore */ }
    if (btn) btn.textContent = _muted ? 'ğŸ”‡ Muted' : 'ğŸ”Š Unmute';
  }

  // â”€â”€ Custom terrain file loading â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  function loadTerrainFile(input) {
    var file = input.files[0];
    if (!file) return;

    var reader = new FileReader();
    reader.onload = function(e) {
      var data = new Uint8Array(e.target.result);
      var vfsPath = '/Data/Terrain/' + file.name;
      try {
        FS.writeFile(vfsPath, data);
        document.getElementById('terrain-file-name').textContent = file.name + ' âœ“';
        Module.ccall('SetCustomTerrainFile', null, ['string'], [vfsPath]);
        console.log('[Nanosaur] Uploaded terrain: ' + vfsPath + ' (' + data.length + ' bytes)');
      } catch (err) {
        console.error('[Nanosaur] Failed to write terrain file:', err);
        document.getElementById('terrain-file-name').textContent = 'Error: ' + err.message;
      }
    };
    reader.readAsArrayBuffer(file);
  }

  function clearCustomTerrain() {
    document.getElementById('terrain-file-name').textContent = '';
    document.getElementById('terrain-file-input').value = '';
    try {
      Module.ccall('ClearCustomTerrainFile', null, [], []);
    } catch (e) {
      console.warn('Module not ready yet:', e);
    }
  }
</script>

{{{ SCRIPT }}}
</body>
</html>
